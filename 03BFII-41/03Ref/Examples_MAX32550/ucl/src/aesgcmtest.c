#include <ucl_testing_config.h>
#ifdef AES_GCM
#ifdef SYSTEM_JIBE
#include <printf_lite.h>
#endif
#ifdef SYSTEM_LIGHTHOUSE
#include <printf_lite.h>
#endif

#include <ucl/ucl_config.h>
#include <ucl/ucl_types.h>
#include <ucl/ucl_defs.h>
#include <ucl/ucl_retdefs.h>

#include <stdlib.h>
#include <ucl/ucl_config.h>
#include <ucl/ucl_defs.h>
#include <ucl/ucl_retdefs.h>
#include <ucl/ucl_types.h>
#include <ucl/ucl_aes_ecb.h>
#include <ucl/ucl_aes_gcm.h>
#include <aesgcmtest.h>

#include <string.h>

#define MAX_PLAINTEXT_HIGH 0x7F
#define MAX_PLAINTEXT_LOW 0xFFFFFF00
#define MAX_AAD_HIGH 0xFFFFFFFF
#define MAX_AAD_LOW 0xFFFFFFFF


int test_mike(void)
{
    u8 plaintext[] = {0x85, 0xc2, 0xda, 0xfb, 0x4c, 0xce, 0xe7, 0xbb,
0x99, 0xbe, 0xce, 0xb8, 0x73, 0x6b, 0xd9, 0xd3, 0x55, 0xac, 0x35, 0x05,
0xcb, 0x99, 0xcb, 0x0e, 0x5c, 0x15, 0x72, 0xd5, 0x18, 0x7e, 0x21, 0x98,
0xbe, 0x9f, 0x82, 0x98, 0x14, 0xe5, 0xa7, 0x49, 0xbd, 0xca, 0x94, 0x66,
0x47, 0x2c, 0xd2, 0xaf, 0xe4, 0x94, 0x13, 0x61, 0xa0, 0x54, 0x3b, 0x9b,
0x82, 0x77, 0x53, 0x28, 0x79, 0x0c, 0xf1, 0x8e, 0xa8, 0xda, 0xe9, 0x9d,
0xb2, 0xab, 0xb3, 0x81, 0x30, 0x85, 0x5b, 0xe9, 0x65, 0x22, 0x31, 0x5a,
0x90, 0x7d, 0x49, 0xfa, 0x37, 0x41, 0xf8, 0xf7, 0x62, 0x8e, 0x41, 0x4a,
0x46, 0x6e, 0xb7, 0x57, 0x14, 0x1b, 0x53, 0xd2, };
    u8 aad[] = {0x33, 0x36, 0x9a, 0x78, 0xd4, 0x78, 0x04, 0xf4, 0xe5,
0xbc, };
    u8 key[] = {0x22, 0xd7, 0x34, 0xae, 0xda, 0x3a, 0x8d, 0xa8, 0xc8,
0x05, 0x6b, 0x25, 0xea, 0x20, 0xbc, 0xd4 };
    u8 iv[] = {0x36, 0xaa, 0x5b, 0x19, 0x18, 0xd2, 0xd0, 0xef, 0x86,
0xa4, 0xef, 0xff, };
    u8 expected_ciphertext[] = {0xd4, 0x4e, 0x15, 0x23, 0xbf, 0xc7,
0x0b, 0xce, 0xac, 0x9b, 0x4a, 0xe4, 0x97, 0x6b, 0xa9, 0x60, 0xb5, 0x05,
0xb1, 0x92, 0x86, 0xbe, 0x14, 0x40, 0xb2, 0x1a, 0x56, 0x9f, 0x0d, 0x28,
0x40, 0x1f, 0x31, 0x7a, 0xf9, 0x91, 0xb3, 0x5c, 0x40, 0x2a, 0xa5, 0x25,
0x71, 0xb1, 0x88, 0xc3, 0x2c, 0xa6, 0x78, 0x54, 0x9d, 0xbc, 0x5f, 0x49,
0xa7, 0xf2, 0x74, 0x0f, 0x31, 0x93, 0x31, 0x35, 0xbf, 0x7d, 0x6d, 0x55,
0x84, 0x1b, 0xf0, 0x36, 0x9b, 0x1a, 0x07, 0x64, 0xe4, 0x42, 0xec, 0x1d,
0x04, 0x6f, 0xd4, 0x62, 0x25, 0xba, 0x0f, 0xdb, 0x15, 0xe8, 0xa4, 0xbf,
0x1a, 0xfb, 0x95, 0x75, 0x3a, 0x29, 0xa8, 0x83, 0xf7, 0x80, };
    u8 expected_tag[] = {0x5d, 0x39, 0x19, 0x3e, 0x51, 0x7d, 0x0b, 0xc3,
0x4f, 0x03, 0x7a, 0xbc, 0x1d, 0x99, 0xb5, 0xdc, };
    u8 ciphertext[100];
    u8 tag[16];
    u8 plaintext_dec[100];

    // Encrypt
    if (ucl_gcm_init_m0(key, sizeof(key), UCL_CIPHER_ENCRYPT) != UCL_OK)
      {
        return 0;
      }
    int rc;
    if ((rc = ucl_aes_gcm(tag, sizeof(tag) * 8, ciphertext, plaintext, 0,
                    sizeof(plaintext) * 8, aad, 0, sizeof(aad) * 8,
                    key, sizeof(key), iv, 0, sizeof(iv) * 8,
                    UCL_CIPHER_ENCRYPT)) != UCL_OK) {
        PRINTF("Failed ucl_aes_gcm() with: %d\n", rc);
        return 0;
    }
    if (memcmp(ciphertext, expected_ciphertext, sizeof(ciphertext)) != 0) {
        return 0;
    }
    if (memcmp(tag, expected_tag, sizeof(tag)) != 0) {
        return 0;
    }

    // Decrypt
    if (ucl_gcm_init_m0(key, sizeof(key), UCL_CIPHER_ENCRYPT) != UCL_OK) {
            return 0;
        }
    if (ucl_aes_gcm(tag, sizeof(tag) * 8, plaintext_dec, ciphertext, 0,
                    sizeof(plaintext) * 8, aad, 0, sizeof(aad) * 8,
                    key, sizeof(key), iv, 0, sizeof(iv) * 8,
                    UCL_CIPHER_DECRYPT) != UCL_OK) {
        return 0;
    }
    if (memcmp(plaintext_dec, plaintext, sizeof(plaintext)) != 0) {
        return 0;
    }

    return 1;
}


int test_large_aes_gcm(void)
{
  u8 plaintext[511] = {0xee, 0xee, 0x59, 0x25, 0xf8, 0x0a, 0x28, 0x34, 0x8f, 0xf4, 0x32, 0x67, 0x76, 0x6d, 0x39, 0x85, 0xc3, 0x44, 0xf4, 0x2d, 0x00, 0x03, 0x5f, 0xc5, 0xc3, 0x48, 0x96, 0x9e, 0x48, 0xd4, 0x22, 0xcf, 0x0b, 0x30, 0xd5, 0x52, 0x86, 0xd7, 0x4b, 0xeb, 0xbb, 0xee, 0x15, 0x63, 0x82, 0x1d, 0xee, 0x29, 0x77, 0x2f, 0x8c, 0x06, 0xe2, 0xac, 0xbc, 0x47, 0x11, 0x08, 0x0c, 0xa8, 0xeb, 0xb5, 0x4a, 0xb6, 0x2a, 0x0a, 0x22, 0x41, 0xf2, 0xd8, 0x0b, 0x18, 0x6e, 0x91, 0x0f, 0xb8, 0x90, 0x7d, 0xed, 0xbf, 0x26, 0x6e, 0xad, 0x60, 0xb6, 0x24, 0x15, 0xeb, 0x64, 0x04, 0x0d, 0x74, 0xa6, 0x5b, 0x3d, 0x15, 0xd4, 0x8b, 0xf6, 0x84, 0x29, 0x00, 0xc9, 0x87, 0x0f, 0x6e, 0x24, 0x88, 0x15, 0x91, 0x78, 0xa1, 0x34, 0xed, 0xb5, 0x60, 0x12, 0x2f, 0x46, 0xa5, 0x1b, 0xe2, 0x1c, 0x7b, 0x83, 0xfe, 0x8d, 0x48, 0x2c, 0x83, 0xed, 0xe3, 0x2e, 0x10, 0x25, 0xf6, 0xfa, 0xd6, 0xaf, 0x9a, 0xfe, 0xc5, 0x41, 0x8a, 0xda, 0x00, 0x85, 0xe5, 0x63, 0x7d, 0x4f, 0x72, 0x0e, 0xd8, 0x72, 0xbe, 0xd1, 0x69, 0x76, 0x5b, 0x31, 0x5e, 0xa3, 0x8d, 0x7d, 0x8b, 0x38, 0x08, 0x36, 0xea, 0x57, 0x37, 0xc3, 0x30, 0x68, 0xa9, 0x25, 0xf3, 0x8b, 0xef, 0x76, 0x52, 0xc8, 0x8f, 0x06, 0xea, 0x70, 0x25, 0x38, 0xf9, 0xb4, 0xdb, 0xe9, 0x22, 0x70, 0x54, 0xdd, 0x7b, 0xf2, 0xfd, 0x4a, 0x4f, 0xbf, 0xc5, 0x13, 0xd3, 0xa3, 0x91, 0x2c, 0x1f, 0x68, 0x09, 0xaa, 0xc5, 0x12, 0xd8, 0xc4, 0xd7, 0x70, 0x51, 0x5a, 0xa1, 0xfa, 0x0d, 0x21, 0xe3, 0x24, 0xb7, 0xd9, 0x00, 0xa2, 0x54, 0xd6, 0x35, 0x8d, 0x39, 0x73, 0xf4, 0x38, 0x06, 0x5e, 0x6b, 0xa4, 0xf8, 0xfb, 0xce, 0x2a, 0xbe, 0xb6, 0x9a, 0x31, 0x11, 0x80, 0x20, 0xb6, 0x51, 0x0f, 0x26, 0xbf, 0xf6, 0x77, 0xfd, 0xb1, 0x0a, 0x3e, 0x27, 0x9f, 0x1c, 0x05, 0x04, 0xae, 0xc0, 0xf2, 0x12, 0x0c, 0x86, 0xab, 0xdb, 0xfb, 0xd2, 0x36, 0xf1, 0x8c, 0xf0, 0x7d, 0x94, 0x45, 0x32, 0xe4, 0xf4, 0xd1, 0x71, 0x7a, 0x10, 0xda, 0xbd, 0xc3, 0xcc, 0x59, 0xce, 0xc6, 0x31, 0x68, 0xcf, 0x21, 0x1c, 0x6f, 0x2f, 0x28, 0xd4, 0x94, 0x83, 0x5d, 0x6c, 0x43, 0xbd, 0xe2, 0xdd, 0xd6, 0x82, 0x0c, 0x4d, 0xce, 0xd3, 0xa8, 0xd2, 0x58, 0x5b, 0x5c, 0xd4, 0xd6, 0x4b, 0x61, 0xb8, 0xa4, 0xc0, 0x36, 0x26, 0x39, 0x21, 0xb8, 0x04, 0xa9, 0xcf, 0x28, 0xd8, 0xd7, 0xc0, 0xbc, 0x37, 0x2f, 0x33, 0x28, 0xad, 0x9d, 0x74, 0x1e, 0xf8, 0xf8, 0x37, 0x7e, 0xa4, 0xb2, 0x46, 0xf5, 0xda, 0x9b, 0xaa, 0x87, 0x11, 0xf0, 0x9d, 0xa7, 0xa2, 0xb6, 0xb7, 0x42, 0x97, 0x83, 0x08, 0x63, 0xe1, 0xd1, 0xc5, 0x9c, 0x24, 0xc6, 0x1c, 0x99, 0x9f, 0x22, 0xdf, 0x24, 0x20, 0x0e, 0x5a, 0x22, 0xf6, 0x32, 0xd1, 0xb5, 0x11, 0x53, 0x9f, 0x70, 0x4c, 0x30, 0x70, 0xb5, 0x48, 0xd1, 0x75, 0x56, 0xb4, 0x60, 0x8b, 0xf5, 0x0d, 0x78, 0xf3, 0xc3, 0x1d, 0xf9, 0x6e, 0x70, 0xe0, 0x06, 0x9e, 0x40, 0x22, 0xd2, 0x4d, 0x3a, 0x4f, 0x62, 0xfe, 0xb4, 0x1a, 0x1d, 0xbd, 0xe6, 0x7e, 0xa6, 0xdf, 0x8b, 0x5f, 0x7e, 0x2f, 0x0d, 0x48, 0x78, 0x6f, 0x85, 0xf3, 0x1a, 0x04, 0x46, 0x8d, 0xcf, 0xe2, 0xf1, 0x2f, 0xce, 0xd9, 0x71, 0xb0, 0xc0, 0x51, 0x7a, 0xb0, 0x06, 0xa1, 0x9b, 0x55, 0x6d, 0x3b, 0x92, 0xc9, 0x1c, 0x85, 0xfc, 0xee, 0x07, 0x57, 0xfc, 0x1a, 0x18, 0x12, 0x12, 0x90, 0x2d, 0x72, 0x7c, 0x04, 0x74, 0xbf, 0xef, 0xa3, 0x1c, 0x06, 0xbc, 0x8f, 0x30, 0xfe, 0x56, 0x72, 0x76, 0x81, 0xc5, 0xa2, 0x25};
  u8 aad[] = {0x59, 0x0c, 0xb4, 0x9f, 0x6c, 0x0a, 0x3a, 0x79, 0x8a, 0x78, 0x11, 0x28, 0x61, 0x5f, 0x23, 0xb3, 0xdb, 0x9b, 0xea, 0x3a, 0x94, 0x2a, 0x9a, 0xa9, 0xfa, 0x55, 0x5b, 0xbd, 0xb6, 0x0e, 0xdc, 0xd0, 0xc9, 0xbc, 0x72, 0x92, 0x5f, 0x1b, 0xaf, 0xc7, 0x91, 0x81, 0xd9, 0x27, 0x3c, 0x0b, 0x2a, 0xc8, 0xf8, 0x78, 0x66, 0x66, 0x20, 0x55, 0xc1, 0xae, 0x75, 0xf3, 0x14, 0xeb, 0x1c, 0x87, 0xac, 0xa1, 0x83, 0x07, 0xb9, 0x57, 0x37, 0x55, 0x75, 0x07, 0xb4, 0xa2, 0x47, 0x10, 0xb4, 0x98, 0x95, 0x1c, 0x6b, 0xfc, 0x2b, 0x02, 0xfb, 0x72, 0xff, 0xdb, 0x8c, 0x54, 0x8b, 0x38, 0x29, 0x3e, 0x9b, 0x9d, 0x40, 0x1a, 0xbc, 0xa1, 0xcc, 0x23, 0xc2, 0xf7, 0xab, 0xec, 0x94, 0xda, 0x07, 0x33, 0x27, 0xfd, 0x8f, 0x93, 0xbc, 0x39, 0x0c, 0x06, 0x5a, 0x33, 0x61, 0x9b, 0xc8, 0x32, 0x32, 0x4d, 0x8b};
  u8 key[] = {0x6d, 0x3c, 0x3f, 0x59, 0x31, 0xcf, 0x3a, 0xeb, 0x74, 0x46, 0xf8, 0x52, 0x27, 0x39, 0xb4, 0x22};
  u8 iv[] = {0xcd, 0x67, 0x2c, 0x95, 0xd7, 0x51, 0x0b, 0x29, 0x51, 0x91, 0xed, 0x05, 0xb4, 0x58, 0x36, 0xb5, 0x30, 0x99, 0x3e, 0x8f, 0xb2, 0x30, 0x85, 0x75, 0x29, 0x21, 0x31, 0xb9, 0x50, 0xef, 0xc3, 0xfb };
  u8 expected_ciphertext[] = {0x46, 0xd2, 0xf5, 0xa2, 0x6d, 0x6f, 0x0c, 0xf9, 0x96, 0xd6, 0xd2, 0x4a, 0xee, 0xfc, 0xc0, 0x31, 0xed, 0xd2, 0x3d, 0x5a, 0x88, 0x73, 0x4d, 0x6f, 0xb6, 0xdd, 0x42, 0xe5, 0xd6, 0x68, 0x9b, 0xd5, 0x8a, 0xa1, 0xe2, 0x8c, 0x21, 0xb2, 0xbf, 0xc9, 0x6e, 0xc3, 0x75, 0xd3, 0x59, 0x5b, 0xf2, 0x38, 0x49, 0x80, 0x7f, 0x9f, 0x36, 0xe5, 0x37, 0x7e, 0xe5, 0xaa, 0x98, 0xc6, 0xfb, 0xb1, 0x2a, 0x20, 0xcc, 0x14, 0xa8, 0xd4, 0xe8, 0x0d, 0x4f, 0x12, 0xc3, 0xe0, 0x33, 0x3f, 0xe8, 0x16, 0x33, 0xd8, 0xd7, 0x51, 0x99, 0xb0, 0x8c, 0xfc, 0x58, 0x40, 0xfe, 0xc9, 0xf6, 0x53, 0x84, 0x9d, 0x5d, 0x29, 0xf8, 0x88, 0xc7, 0x58, 0xa4, 0xc8, 0x66, 0xfe, 0xac, 0x90, 0xa3, 0xea, 0x7c, 0x5d, 0x71, 0x0e, 0x4a, 0xa1, 0xd6, 0xd2, 0x67, 0x8a, 0x1b, 0xd8, 0x55, 0xe2, 0xcf, 0x47, 0x94, 0xe7, 0x9a, 0x1d, 0xba, 0xbe, 0xf7, 0x9d, 0xd1, 0x82, 0xc3, 0xdf, 0xe9, 0x67, 0x24, 0x8c, 0x46, 0x08, 0x7e, 0x8b, 0xb9, 0x38, 0x1c, 0x8d, 0x97, 0xef, 0xa7, 0xbf, 0xa4, 0xf2, 0xf8, 0x67, 0x9b, 0x4a, 0x04, 0xa9, 0xfb, 0x7d, 0xc1, 0xc5, 0x2d, 0xc4, 0xed, 0x51, 0x8b, 0x2e, 0xfb, 0xe3, 0x6e, 0x39, 0x7a, 0x1a, 0xc6, 0x5b, 0x74, 0xa6, 0x4b, 0x76, 0xd7, 0xb0, 0x92, 0x26, 0x3d, 0x3f, 0xc4, 0xe0, 0x4b, 0x3d, 0x16, 0x58, 0xda, 0x44, 0x5e, 0x94, 0xd7, 0xc4, 0xd8, 0x3f, 0xd9, 0x24, 0xdb, 0x15, 0xc6, 0x9c, 0x48, 0x97, 0x37, 0xfb, 0x7c, 0x39, 0x71, 0xe6, 0xe0, 0xf6, 0x73, 0x4e, 0x7a, 0xcc, 0xad, 0xda, 0xaa, 0xa6, 0x7e, 0xce, 0xd2, 0x53, 0x3b, 0x14, 0xe2, 0x23, 0x48, 0x5c, 0xb4, 0xff, 0xb6, 0xf7, 0xf0, 0x74, 0x2d, 0x59, 0x2d, 0xe1, 0x6d, 0xfd, 0x32, 0x0f, 0x68, 0x76, 0xa5, 0xbf, 0x5b, 0x0c, 0xff, 0x83, 0x38, 0x01, 0x1d, 0x24, 0xa3, 0xf9, 0x84, 0x66, 0x20, 0xa3, 0x8f, 0xf1, 0xea, 0xb0, 0x18, 0x04, 0xfe, 0x70, 0x4e, 0x10, 0x54, 0xbf, 0xf9, 0xb1, 0x26, 0x80, 0x62, 0x5e, 0xea, 0xe7, 0x01, 0xfa, 0x64, 0x01, 0xeb, 0x29, 0x42, 0x0e, 0xce, 0x1d, 0x17, 0x2c, 0xcd, 0x5e, 0x80, 0xda, 0xf3, 0xaa, 0x29, 0xc3, 0x85, 0xaa, 0x8c, 0x1f, 0x37, 0x0d, 0xe3, 0x1c, 0x03, 0x40, 0x3a, 0xe5, 0x40, 0x7a, 0x7f, 0xdb, 0x30, 0x31, 0xf2, 0xbb, 0xbc, 0x33, 0xb1, 0x90, 0x8e, 0x97, 0x43, 0xae, 0xd6, 0xbf, 0xe5, 0xd1, 0xc0, 0x2b, 0x93, 0x42, 0x84, 0x8d, 0x88, 0xb1, 0xa5, 0x31, 0xb0, 0xf6, 0xad, 0x00, 0x53, 0x9f, 0xb6, 0x70, 0x2a, 0xa7, 0xf4, 0xc4, 0x7c, 0x6a, 0x17, 0x1d, 0x1f, 0xeb, 0x7a, 0xa8, 0xa8, 0x48, 0x6f, 0xd1, 0x5c, 0x00, 0x59, 0x4c, 0x0f, 0xd4, 0x35, 0x30, 0xc2, 0xb5, 0xcf, 0x7d, 0x3c, 0xe5, 0xf7, 0xed, 0x88, 0x0d, 0x79, 0x02, 0x75, 0x19, 0xc0, 0xf5, 0xd1, 0xa8, 0x5a, 0xcd, 0xd2, 0xc3, 0x85, 0x20, 0x74, 0xa3, 0x8b, 0x3c, 0x9b, 0x0f, 0x76, 0x10, 0xb7, 0x99, 0x05, 0x73, 0x51, 0x83, 0x25, 0x7b, 0xf9, 0x1b, 0x83, 0xdf, 0x0d, 0x9c, 0x35, 0x7a, 0x4d, 0x39, 0xe8, 0x25, 0x8c, 0x23, 0x82, 0x03, 0x09, 0x58, 0x54, 0x71, 0x92, 0xb9, 0x5e, 0x03, 0x6d, 0x5b, 0x27, 0x86, 0xe4, 0xe8, 0x5f, 0x3c, 0x89, 0xd7, 0xe5, 0x76, 0xec, 0x1f, 0xbe, 0xb8, 0xbb, 0x3a, 0x6f, 0x55, 0x44, 0x68, 0x74, 0x23, 0x51, 0xc8, 0x47, 0x41, 0x4b, 0x24, 0x4f, 0xc8, 0xbe, 0x45, 0xf8, 0x70, 0x24, 0x18, 0xcc, 0xe5, 0x99, 0x2f, 0x14, 0x1e, 0x2c, 0xd2, 0xa1, 0xf6, 0x17, 0xdb, 0x9d, 0x67, 0xe1, 0x8e, 0x99, 0x37, 0xbc, 0xab, 0x7b, 0x79, 0x00, 0x2a, 0x42, 0x21, 0xd7};
  u8 expected_tag[] = {0x80, 0x44, 0x4b, 0xa6, 0x74, 0x89, 0xb2, 0x51, 0xf5, 0x7c, 0xe2, 0xc2, 0x54, 0x37, 0x03 };
  u8 ciphertext[511];
  u8 tag[sizeof(expected_tag)];
  u8 res[UCL_AES_BLOCKSIZE];

  u8 h[UCL_AES_BLOCKSIZE];
  u8 eky0[UCL_AES_BLOCKSIZE];
  u8 y[UCL_AES_BLOCKSIZE];

  if (ucl_gcm_init_m0(key, sizeof(key), UCL_CIPHER_ENCRYPT) != UCL_OK)
    {
      return UCL_ERROR;
    }

 if (ucl_aes_gcm(tag, sizeof(tag) * 8, ciphertext, plaintext, 0, 511* 8, aad, 0, sizeof(aad) * 8, key, sizeof(key), iv, 0, sizeof(iv) * 8, UCL_CIPHER_ENCRYPT) != UCL_OK)
    {
      return UCL_ERROR;
    }
  
  if (memcmp(tag, expected_tag, sizeof(tag)) != 0)
    {
      PRINTF("ERROR: Invalid tag\n");
      return UCL_ERROR;
    }
  
  if (memcmp(expected_ciphertext, ciphertext, sizeof(expected_ciphertext)) != 0)
    {
      PRINTF("ERROR: Invalid ciphertext\n");
      return UCL_ERROR;
    }
  memset(ciphertext,0,511);
  memset(tag,0,sizeof(tag));
  if (ucl_aes_gcm_auth(tag, sizeof(tag) * 8, ciphertext, plaintext, 0, 511* 8, aad, 0, sizeof(aad) * 8, key, iv, 0, sizeof(iv) * 8, UCL_CIPHER_ENCRYPT) != UCL_OK)
    {
      return UCL_ERROR;
    }
  if (memcmp(tag, expected_tag, sizeof(tag)) != 0)
    {
      PRINTF("ERROR: Invalid tag\n");
      return UCL_ERROR;
    }
  
  if (memcmp(expected_ciphertext, ciphertext, sizeof(expected_ciphertext)) != 0)
    {
      PRINTF("ERROR: Invalid ciphertext\n");
      return UCL_ERROR;
    }
  
  ucl_aes_gcm_init(res,h,eky0,y,aad,0,sizeof(aad)*8,key,sizeof(key),iv,0,sizeof(iv)*8,UCL_CIPHER_ENCRYPT);
  ucl_aes_gcm_core(res,120,ciphertext,plaintext,0,31*128,0,sizeof(aad)*8,h,y,key,sizeof(key),UCL_CIPHER_ENCRYPT);
  ucl_aes_gcm_finish(tag,120,res,&(ciphertext[31*16]),&(plaintext[31*16]),0,120,0,511*8,0,sizeof(aad)*8,h,eky0,y,key,sizeof(key),UCL_CIPHER_ENCRYPT);
  if (memcmp(tag, expected_tag, sizeof(tag)) != 0)
    {
      PRINTF("ERROR: Invalid tag\n");
      return UCL_ERROR;
    }
  
  if (memcmp(expected_ciphertext, ciphertext, sizeof(expected_ciphertext)) != 0)
    {
      PRINTF("ERROR: Invalid ciphertext\n");
      return UCL_ERROR;
    }
 
  return UCL_OK;
  
    /**
     *
     * Other examples:
     *
     * Openssl FIPS output:
     *
Key = 04c6dc25c1f40772856fbd3f75bffa6c
IV = 877b5a4b1d26798d60b45e7dcbd7525a248b2fda51bda807cef52bdee439f834
PT = 443f8719f230880848179d2add0694c7320aff9e32be570fda27cb727bec0081f638676bcbd43b09c0369177e5cf6fd04bba02fc5330a287f590ed1c381c27fe5e61d108f775defa708472f589706db48e4c5264d8f772d4775ce1f9da3d6e92001366417c290d2f874f5f89161855da4ca50fb3e3d66a216c621517d20521235c6d43434730479de8de64e505fa374a439186173c55eeae891930c5fe13aec8f751b8029dcca88b4e71bf10e6761568136a3b5713430061cd28e64b20403d48783f1126611f246d746bc0b0b3b761c129339795b78ef9d776cb76f00c9fdb0ab04043db8bea28e9281b03668c2b30ddca1e3cf93e0efc3d69d98cc108b8f8db300215749fe48dda46b41f15a6db1d4eff9fe4d6d1b271d0d03ba07d28e8631193778517cd0064dc5a577155ba144032492b9fa8b8b9757370f9661ed57967a85cff18bb574be32442987b35ff55bca5c1fe83c0f947a67cbd355a91179667a6dd2b5669bd010b9ed129453fedd158613f242a603697bd799927475a7fc86a841620d050b4719794b5ffd673570c4b7437f17e46f152d8b2b21c36cb7252c777c9bcd65b0cf3693cc29ab470cbfe7a4bd68d2a6bd36aea2d534509c434ee8c723c399e0bed7dae544fba9a906f96fc9c030371b4b7e29df9121a309469f581154633f94c85509f321abff1247d865a9c516304a8d910ba4667ba2637d532d0
AAD = 02ab79fbc4d8bb8ecb32b37d0953ad3a98cf8ff5c58a8cb4092680d7110f7803ad7a7b6b540ae5c5fe74f7a4d704b65fc9726863b3869b217f9f2372d94987369f4fd59657c33ce6c92ac3c09ac2cea53863a7e8f95631af67ea1e223c43011cd21b41b80db0564a1c23e06d31a113b05f98a99037f90a70724efcb19c218c
CT = 90b12e5cf0fc4401a6976334673add1df3994cc58fd787ddb303f12bb8021e05ce7e7b042d5f55a18d985f99f041e5deb087d331e3e2dc07f0cd3ce7d5a4440a998319debfaa455d4f413f26bef16b9eddf4be43d2857efc268c47191a7a566f25dfd18626b36f7ac7c7f2702c61f669089c89c3943ede4a7de141628a316524cd25eaf8ba15cb71510f9fcb54a34a9ad05c9ae56596a6802c5c14d410b8e79af0965146b7f38dfb5a83981a77635d58aa5368cd882c1d5cb711fdf716f34308a7663ce4d113c3879976309fe463436923403f3bd3c7dd5af163967b7af02492da516a5c36fece8d9fa9d60442bddf0ce295a6800053b49c7cfee0511dcead3023f6ef6b56fe67d62b4688e0c565a34672afa5f882a620b3feebf582307a690ba8bbb00751f3e99c9069e1d9f3540f84387447de41f4f27e4476ab27761353fc9303bafe709ee01822d4a78213dd621d40590da28d7707b9eaae32a2b896bd20cfc30e6ece640a3bfd91a4cd24b055007c66b0aa3a81d5f322c01601cfc76196fdaa8096cac38eb665f4170e9670d96ab97d73e48178dbbc6e25d6f5499115247948506b13e5c832ca85363cebbd2190810f5219531c2ee32582d0fbfc61dd5a6f4cf249365ee76dc986dd18c9dd128783f8d11bd39fd60ea0c97b101df3209bef2714f19494eb79d79f33bbe2aac172a7e18ed351fd98387cdd0c18e8421c
Tag = 1bd6e80f2ee36eb0ebb1337e



========================================

Openssl FIPS output:

Key = 1b471c690f2619d54a486f28b70a2f3c
IV = 6a59209d2992a543722780fbbb3cabee5b2d214ec88845c15e217921e54f91a3c5b0b156a44d6fd336b000800dfefaf30ccdedb0f4bee9d8fd4b45bf46c976fb
PT = 54567ab0df29cd96d7c75536c5a5c87980e912338a11a80d1b14034b7b777102e3c753676269d47bdae6299c9931c886822b2d4cb94c2d846d705e38c932986dbac015370ea87cef264c7cae4869bd5d82a3bf0aa09f034feea47acba7603060739b6375c7b9c41e262ae654b6432630745b0dcb6036eea00fea5d3170c842efa73df69a8f2c7fc35fadca870304beb9828b1fb16d243a4fe5aa290a0f6604fd512d5fe8b540293330ef41ae24bebe5017170ac4ac4703478c96a2f9f1fe0924a8959a73f98f2cdad17b792c2bffa4cd4410e40eed0b89d0aa91993cfbf3b5a3521420bcb4a9b9fa541c7c6766e71c10699ff5e7bdcfe534a5255475be10f63e2f1c87b6aa25fb22a9a2c00df69141b26ebc9fc2867eaacad146a71fe2f196590307c04a5148bce79a013d529eef60ca1598ce60f3d547126fd5493ae2eef34a49de9ea9b917b01966e571724f8b5bdf7813c541e0c3632aad89f8d57631d9ff1deaa53b7a9a5d50eff0a404c20176daa4f238a474badf377bca7f296d863a8f84f47424852052b9f694112628f36f2c26327c6c97a894682a5ae775c615f01d19bff3f69e3d68ddf1380bc251b43fa4fa430ed8487194c3d8f2eab6d4dc5ab889e374d99fd63bf16a7fbddd965401dede1aa4d9427a5554992a3ed4193f90d595560131c169313041a644cfc28eeb0282bf17cac692a30ca0f7df4993fb823c
AAD = 842074271d506214e41b61c3ea8a53a6304dddab4dddf7661ffe8b4332f7239a6e1b457e90cc85c3dd0f61e88d8c96d6b237fde1b998a03904add0e5f6cd37c5b96449aa35bfa63571d18cc04a0604451a413461d545851c8978baa83c172967ecbebed14093e0402172986e60defa03b5a392a06c6af9c802f740e3468d52
CT = 80a20636adfd35dba335ec68ecd85249fa882037c7e8dd3c2c46c3403bbb963577da3751e98343b43347cfa893dd165925c2b8cead70877412bfa0d821fb473e1bd631543162a48cfcf3eafe0eef652aeb1731fc6b42c83f77e4fa96cd57c8ecc8976b97a10f45f9addad03dd46f13b9109901835b4b479130414dc380c5f25df396503224d5d9bf0e269dc3a1c2ff2516fbe9091819c0585b5bf53f0932173fb9bd01b733cfe94ba9bd56a1ffea448a8d3771b7ef99631e96d4da92797a39abfbb0fa01921bb6d002046ab1024ec3924af0c6822bd11159f4d16e93f4da0a28703b47c8e5ea5884cb0847455df082da9cff35f64fe710ecb58bf1b3c2c0d1029067dfddd8eeed4960700ef9d36e6c9c8a8c6323a4bb57f26eefc4d06ea3eca565eeb05fb0532c6abb444213e1538b9cc995b08969a9ef273a9b83219c1945515a1c2a4c504ddd8792c84d1a07c4efd10761229698ee5b72a68d61d97534e516d4e8e14f026dabe789a05dc5b25597305c596af37c8238bcb62b0ef23f92ac006f3e0b72d72829653a89a46d897fac16b95cc415b942b6f5c713f380131f55829714b4fbb3b0d656db0723ceed0bb9d8e0d8f0b49272eb4b7b5f02bced78af4008d7fb3a9f6c6397592e5f80cd26bd114fae4057b5937c3d3f72fe0c84e006766311b9bdcd12440647c1abbe0f2df95a94c8e8139fd8bead5002fe6240b19b07
Tag = af3a135e9eda7beb0366660a


     *
     *
     *
     *
     * =========================================================================
     *
     * The following cases also do not match the fips module.
     *
Key = 0d459907275bf2e2b4b8f8f6e51478f12426563e25ceb1bf
IV = 753f960644dfd46b39294fee368e52f7ce5ae288951f74a154a8edbc79f7fc73
PT = 94c272c2295db458707ea970f99a55ebf4f8c7fa9c7beeb4eb2cc302d17d8b690525aabd90bc014a81e155034604f8ca1036d926fb47e251b463cebe2c4e883b6e689eb9cfa69a1fbf0c3d5fc1274194bfc71fed2acd8022391ff1b530b28efff9762bd02d603389e29d826e8079a712f1cf731a57b44c1fa0ef84a579312be5
AAD = 6a2bb743739f90e3a7fca44386b8a1482bd0b81ab0e7a115e6b4faf8902995fbe0b0969f54b525457acc781c3fdbbfb66e62fe4b03f1591cd6e0a7d4be8de4e2b4459cd35434402463e7b2f20917f6cb0733f23a77c40f664762fc515486cc0fb0035450ed95810fccc5fc038bda13d79646a74b1570de6bfc40c214caae3ef270d0453461ad86ace587cc38abc89c819f081f3d435c30550e30398a2d351e76bc0a0c290833fc8e1927e1cf3814bbb2c671faa217d4940a917d45100bcb17e3a738264c7526388ce36cb9a0ad4b203d23a6d07627dc3d2078404f0c68fc59f938acf0f8c1916af4282a4a0d4dfe7c71444eb297de2aeb130aa234bf7a3fb1c039940828d3f4301caa8529bf6e362f5551da9b9bff345650c666de3e4f89a1554efc79706df3fd3097a260c1b664ef343a1983fb6e528854f2c94bdacb57181838d725c27dcea9949531e1224e0f2ab9565cb211d40aeeaba422c330fb291488f2381af76397fb667d541ee9178b14b0d156d250f35c99febf1fbb3bf3ebf51a59ed89e75b9bebe14c78e32cae6c6b61e2fccc3b7ff1da73dcbb1d9c85b65016204731a62ab8d23b37f5780b63a79a6247f040a9729a999f027f56ee5a367fd6bcab583c15cdc3e85552021c489c5ad0268ce32876211ebcbcbb4e34bb1f4b1b7bcc047dd76f47b07b75df8b0a17941fc0be53585d22b07007178daf1a2632

Count = 0
Key = f1bdc16e02705c6c312bc47c9de4aa13b5ad40350907413bb375e5ce2806bde6
IV = 26988981a28238c5df68713c3ff8866c956621ef9b893713c771c115ffaf8b04
PT = dade722ad1d6c73f62be7d8b1c733a9b13e298496de3d01d1767be97928b95eabd24b9fb5b1681f4c17e69e1df81b5487915bca8453961c226e93d1a0a9bb2d1711b015615d18c39c25733905aea6b4380dce03e523a364410ede7cddde3d71b6c22bef65739d95b24cdcd11fed23f38a8ea482dff3757d842a5dbba486056e75d4759b96bbb3a804cb0e831fdfc91820e5cb92c4b2de942a372d5554e8c37195496b4bbbc14399d1f88f63b5f85a414a3233ad4fe4e56280f8c38daa7a2dcc545126556b179b5f82f5207aa1d1a2494c56af569a219066f956cedf2ec159168289dff5d7345136fc7bf59b2976994cdd1e9f571f3b754b4403052a09f9c92a708d475ca8c326272bb0c3a0178db5977c6b1da420cb6da702a149185955f18c4aef2f1aeffc3a63ffdf09816d98ee3d9d75abb6b15aec38c81e5f3ec492a7c340661a785a98420bc9d591104e5033375181f50716b69e626eaeca9c1950068250a2f63b3ed4716f037ee6d8b8b2bdc12d87cbda71227c3baf8441285e6789f8696d3c0c963e2a2193fa891bf1b62ddc58304befa92d4a3ebb76465544bf006f2a772058d75486ea2098f0a51c919c9d9540f1dde98668a065416fbf49c3e0cedfe9b0ef06b22a3f2d16dd99b785679847204b2b2f00a6bbdd5f453d8c9badfaffe0178087bc8e61a6f577be5b9d300e70e0d2399b948ed91c95bb6cd0a4200
AAD = b7e6e8c19b2b46ee330a6ee8aa1c4885e8cfbcdc0c990e4ab9a588f0416f5133e7f796e3397fb57e3515de18c84e0bbffd480c605e7e79d1aaa007bea27209a4469c67c0672170885757137fa28c00811208cb0f4f6141624015848eba4ee0d2cf03b5179b7d652f979813489690c72ba7d1d09f65555c3b4391dac694167eee
     *
     *
     */
}


int test_aes_gmac(void)
{
  //test vectors from http://www.mail-archive.com/stds-p1619@listserv.ieee.org/msg00321.html
  u8 key[UCL_AES_KEYLEN_128]={0xfe,0xff,0xe9,0x92,0x86,0x65,0x73,0x1c,0x6d,0x6a,0x8f,0x94,0x67,0x30,0x83,0x08};
  u8 iv[96/8]={0xca,0xfe,0xba,0xbe,0xfa,0xce,0xdb,0xad,0xde,0xca,0xf8,0x88};
  u8 aad[UCL_AES_BLOCKSIZE]={0xfe,0xed,0xfa,0xce,0xde,0xad,0xbe,0xef,0xfe,0xed,0xfa,0xce,0xde,0xad,0xbe,0xef};
  u8 tag[UCL_AES_BLOCKSIZE]={0x54,0xdf,0x47,0x4f,0x4e,0x71,0xa9,0xef,0x8a,0x09,0xbf,0x30,0xda,0x7b,0x1a,0x92};
  u8 tagres[UCL_AES_BLOCKSIZE];
  u8 key1[UCL_AES_KEYLEN_128]={0xfe,0xff,0xe9,0x92,0x86,0x65,0x73,0x1c,0x6d,0x6a,0x8f,0x94,0x67,0x30,0x83,0x08};
  u8 iv1[96/8]={0xca,0xfe,0xba,0xbe,0xfa,0xce,0xdb,0xad,0xde,0xca,0xf8,0x88};
  u8 aad1[32]={0xfe,0xed,0xfa,0xce,0xde,0xad,0xbe,0xef,0xfe,0xed,0xfa,0xce,0xde,0xad,0xbe,0xef,0xab,0xad,0xda,0xd2,0x42,0x83,0x1e,0xc2,0x21,0x77,0x74,0x24,0x4b,0x72,0x21,0xb7};
  u8 tag1[UCL_AES_BLOCKSIZE]={0x1c,0xbe,0x39,0x36,0xe5,0x53,0xb0,0x8f,0x25,0xc0,0x8d,0x7b,0x8d,0xc3,0x9f,0xdb};
  int resu;
  int i;
  resu=ucl_aes_gmac_auth(tagres,128,aad, 0,128, key,iv,0, 96);
  if(UCL_OK==resu)
    {
      for(i=0;i<UCL_AES_BLOCKSIZE;i++)
	{
	  if(tagres[i]!=tag[i])
	    {
	      PRINTF("ERROR-1: %02x %02x [%d]\n",tagres[i],tag[i],i);
	      return(UCL_ERROR);
	    }
	}
     }
  else
    return(UCL_ERROR);
  resu=ucl_aes_gmac_auth(tagres,128,aad1, 0,256, key1,iv1,0, 96);
  if(UCL_OK==resu)
    {
      for(i=0;i<UCL_AES_BLOCKSIZE;i++)
	{
	  if(tagres[i]!=tag1[i])
	    {
	      PRINTF("ERROR-1: %02x %02x [%d]\n",tagres[i],tag1[i],i);
	      return(UCL_ERROR);
	    }
	}
     }
  else
    return(UCL_ERROR);
  return(UCL_OK);
}


int test_aes_gcm(void)
{
  //test vectors from mcgrew-viega
  u8 t[UCL_AES_BLOCKSIZE];
  u8 tprime[256];
  u8 key[UCL_AES_KEYLEN_128]={0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};
  u8 pnull[UCL_AES_BLOCKSIZE]={0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};
  u8 ivnull[96/8]={0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};
  u8 p[UCL_AES_BLOCKSIZE];
  u8 pprime[64];
  u8 c[UCL_AES_BLOCKSIZE];
  u8 a[UCL_AES_BLOCKSIZE];
  u8 expected_t_case1[UCL_AES_BLOCKSIZE]={0x58,0xe2,0xfc,0xce,0xfa,0x7e,0x30,0x61,0x36,0x7f,0x1d,0x57,0xa4,0xe7,0x45,0x5a};
  u8 expected_t_case2[UCL_AES_BLOCKSIZE]={0xab,0x6e,0x47,0xd4,0x2c,0xec,0x13,0xbd,0xf5,0x3a,0x67,0xb2,0x12,0x57,0xbd,0xdf};
  u8 expected_c_case2[UCL_AES_BLOCKSIZE]={0x03,0x88,0xda,0xce,0x60,0xb6,0xa3,0x92,0xf3,0x28,0xc2,0xb9,0x71,0xb2,0xfe,0x78};

  u8 key3[UCL_AES_KEYLEN_128]={0xfe,0xff,0xe9,0x92,0x86,0x65,0x73,0x1c,0x6d,0x6a,0x8f,0x94,0x67,0x30,0x83,0x08};
  u8 c3[4*UCL_AES_BLOCKSIZE];
  u8 p3[4*UCL_AES_BLOCKSIZE]={0xd9,0x31,0x32,0x25,0xf8,0x84,0x06,0xe5,0xa5,0x59,0x09,0xc5,0xaf,0xf5,0x26,0x9a,0x86,0xa7,0xa9,0x53,0x15,0x34,0xf7,0xda,0x2e,0x4c,0x30,0x3d,0x8a,0x31,0x8a,0x72,0x1c,0x3c,0x0c,0x95,0x95,0x68,0x09,0x53,0x2f,0xcf,0x0e,0x24,0x49,0xa6,0xb5,0x25,0xb1,0x6a,0xed,0xf5,0xaa,0x0d,0xe6,0x57,0xba,0x63,0x7b,0x39,0x1a,0xaf,0xd2,0x55};
  u8 iv3[96/8]={0xca,0xfe,0xba,0xbe,0xfa,0xce,0xdb,0xad,0xde,0xca,0xf8,0x88};
  u8 expected_c_case3[]={0x42,0x83,0x1e,0xc2,0x21,0x77,0x74,0x24,0x4b,0x72,0x21,0xb7,0x84,0xd0,0xd4,0x9c,0xe3,0xaa,0x21,0x2f,0x2c,0x02,0xa4,0xe0,0x35,0xc1,0x7e,0x23,0x29,0xac,0xa1,0x2e,0x21,0xd5,0x14,0xb2,0x54,0x66,0x93,0x1c,0x7d,0x8f,0x6a,0x5a,0xac,0x84,0xaa,0x05,0x1b,0xa3,0x0b,0x39,0x6a,0x0a,0xac,0x97,0x3d,0x58,0xe0,0x91,0x47,0x3f,0x59,0x85};
  u8 expected_t_case3[]={0x4d,0x5c,0x2a,0xf3,0x27,0xcd,0x64,0xa6,0x2c,0xf3,0x5a,0xbd,0x2b,0xa6,0xfa,0xb4};

  //key4 is key3
  u8 c4[60];
  u8 p4[60]={0xd9,0x31,0x32,0x25,0xf8,0x84,0x06,0xe5,0xa5,0x59,0x09,0xc5,0xaf,0xf5,0x26,0x9a,0x86,0xa7,0xa9,0x53,0x15,0x34,0xf7,0xda,0x2e,0x4c,0x30,0x3d,0x8a,0x31,0x8a,0x72,0x1c,0x3c,0x0c,0x95,0x95,0x68,0x09,0x53,0x2f,0xcf,0x0e,0x24,0x49,0xa6,0xb5,0x25,0xb1,0x6a,0xed,0xf5,0xaa,0x0d,0xe6,0x57,0xba,0x63,0x7b,0x39};
  u8 a4[20]={0xfe,0xed,0xfa,0xce,0xde,0xad,0xbe,0xef,0xfe,0xed,0xfa,0xce,0xde,0xad,0xbe,0xef,0xab,0xad,0xda,0xd2};
  u8 iv4[96/8]={0xca,0xfe,0xba,0xbe,0xfa,0xce,0xdb,0xad,0xde,0xca,0xf8,0x88};
  u8 expected_c_case4[60]={0x42,0x83,0x1e,0xc2,0x21,0x77,0x74,0x24,0x4b,0x72,0x21,0xb7,0x84,0xd0,0xd4,0x9c,0xe3,0xaa,0x21,0x2f,0x2c,0x02,0xa4,0xe0,0x35,0xc1,0x7e,0x23,0x29,0xac,0xa1,0x2e,0x21,0xd5,0x14,0xb2,0x54,0x66,0x93,0x1c,0x7d,0x8f,0x6a,0x5a,0xac,0x84,0xaa,0x05,0x1b,0xa3,0x0b,0x39,0x6a,0x0a,0xac,0x97,0x3d,0x58,0xe0,0x91};
  u8 expected_t_case4[]={0x5b,0xc9,0x4f,0xbc,0x32,0x21,0xa5,0xdb,0x94,0xfa,0xe9,0x5a,0xe7,0x12,0x1a,0x47};


  //key5 is key3
  u8 c5[60];
  u8 p5[60]={0xd9,0x31,0x32,0x25,0xf8,0x84,0x06,0xe5,0xa5,0x59,0x09,0xc5,0xaf,0xf5,0x26,0x9a,0x86,0xa7,0xa9,0x53,0x15,0x34,0xf7,0xda,0x2e,0x4c,0x30,0x3d,0x8a,0x31,0x8a,0x72,0x1c,0x3c,0x0c,0x95,0x95,0x68,0x09,0x53,0x2f,0xcf,0x0e,0x24,0x49,0xa6,0xb5,0x25,0xb1,0x6a,0xed,0xf5,0xaa,0x0d,0xe6,0x57,0xba,0x63,0x7b,0x39};
  u8 a5[20]={0xfe,0xed,0xfa,0xce,0xde,0xad,0xbe,0xef,0xfe,0xed,0xfa,0xce,0xde,0xad,0xbe,0xef,0xab,0xad,0xda,0xd2};
  u8 iv5[8]={0xca,0xfe,0xba,0xbe,0xfa,0xce,0xdb,0xad};
  u8 expected_c_case5[60]={0x61,0x35,0x3b,0x4c,0x28,0x06,0x93,0x4a,0x77,0x7f,0xf5,0x1f,0xa2,0x2a,0x47,0x55,0x69,0x9b,0x2a,0x71,0x4f,0xcd,0xc6,0xf8,0x37,0x66,0xe5,0xf9,0x7b,0x6c,0x74,0x23,0x73,0x80,0x69,0x00,0xe4,0x9f,0x24,0xb2,0x2b,0x09,0x75,0x44,0xd4,0x89,0x6b,0x42,0x49,0x89,0xb5,0xe1,0xeb,0xac,0x0f,0x07,0xc2,0x3f,0x45,0x98};
  u8 expected_t_case5[UCL_AES_BLOCKSIZE]={0x36,0x12,0xd2,0xe7,0x9e,0x3b,0x07,0x85,0x56,0x1b,0xe1,0x4a,0xac,0xa2,0xfc,0xcb};

  //key6 is key3
  u8 c6[60];
  u8 p6[60]={0xd9,0x31,0x32,0x25,0xf8,0x84,0x06,0xe5,0xa5,0x59,0x09,0xc5,0xaf,0xf5,0x26,0x9a,0x86,0xa7,0xa9,0x53,0x15,0x34,0xf7,0xda,0x2e,0x4c,0x30,0x3d,0x8a,0x31,0x8a,0x72,0x1c,0x3c,0x0c,0x95,0x95,0x68,0x09,0x53,0x2f,0xcf,0x0e,0x24,0x49,0xa6,0xb5,0x25,0xb1,0x6a,0xed,0xf5,0xaa,0x0d,0xe6,0x57,0xba,0x63,0x7b,0x39};
  u8 a6[20]={0xfe,0xed,0xfa,0xce,0xde,0xad,0xbe,0xef,0xfe,0xed,0xfa,0xce,0xde,0xad,0xbe,0xef,0xab,0xad,0xda,0xd2};
  u8 iv6[60]={0x93,0x13,0x22,0x5d,0xf8,0x84,0x06,0xe5,0x55,0x90,0x9c,0x5a,0xff,0x52,0x69,0xaa,0x6a,0x7a,0x95,0x38,0x53,0x4f,0x7d,0xa1,0xe4,0xc3,0x03,0xd2,0xa3,0x18,0xa7,0x28,0xc3,0xc0,0xc9,0x51,0x56,0x80,0x95,0x39,0xfc,0xf0,0xe2,0x42,0x9a,0x6b,0x52,0x54,0x16,0xae,0xdb,0xf5,0xa0,0xde,0x6a,0x57,0xa6,0x37,0xb3,0x9b};
  u8 expected_c_case6[60]={0x8c,0xe2,0x49,0x98,0x62,0x56,0x15,0xb6,0x03,0xa0,0x33,0xac,0xa1,0x3f,0xb8,0x94,0xbe,0x91,0x12,0xa5,0xc3,0xa2,0x11,0xa8,0xba,0x26,0x2a,0x3c,0xca,0x7e,0x2c,0xa7,0x01,0xe4,0xa9,0xa4,0xfb,0xa4,0x3c,0x90,0xcc,0xdc,0xb2,0x81,0xd4,0x8c,0x7c,0x6f,0xd6,0x28,0x75,0xd2,0xac,0xa4,0x17,0x03,0x4c,0x34,0xae,0xe5};
  u8 expected_t_case6[]={0x61,0x9c,0xc5,0xae,0xff,0xfe,0x0b,0xfa,0x46,0x2a,0xf4,0x3c,0x16,0x99,0xd0,0x50};

  //AES 192
  u8 key7[UCL_AES_KEYLEN_192]={0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};
  u8 expected_t7[UCL_AES_BLOCKSIZE]={0xcd,0x33,0xb2,0x8a,0xc7,0x73,0xf7,0x4b,0xa0,0x0e,0xd1,0xf3,0x12,0x57,0x24,0x35};
  //p8 is pnull
  u8 expected_c8[UCL_AES_BLOCKSIZE]={0x98,0xe7,0x24,0x7c,0x07,0xf0,0xfe,0x41,0x1c,0x26,0x7e,0x43,0x84,0xb0,0xf6,0x00};
  u8 expected_t8[UCL_AES_BLOCKSIZE]={0x2f,0xf5,0x8d,0x80,0x03,0x39,0x27,0xab,0x8e,0xf4,0xd4,0x58,0x75,0x14,0xf0,0xfb};


  u8 key9[UCL_AES_KEYLEN_192]={0xfe,0xff,0xe9,0x92,0x86,0x65,0x73,0x1c,0x6d,0x6a,0x8f,0x94,0x67,0x30,0x83,0x08,0xfe,0xff,0xe9,0x92,0x86,0x65,0x73,0x1c};
  u8 p9[64]={0xd9,0x31,0x32,0x25,0xf8,0x84,0x06,0xe5,0xa5,0x59,0x09,0xc5,0xaf,0xf5,0x26,0x9a,0x86,0xa7,0xa9,0x53,0x15,0x34,0xf7,0xda,0x2e,0x4c,0x30,0x3d,0x8a,0x31,0x8a,0x72,0x1c,0x3c,0x0c,0x95,0x95,0x68,0x09,0x53,0x2f,0xcf,0x0e,0x24,0x49,0xa6,0xb5,0x25,0xb1,0x6a,0xed,0xf5,0xaa,0x0d,0xe6,0x57,0xba,0x63,0x7b,0x39,0x1a,0xaf,0xd2,0x55};
  u8 iv9[12]={0xca,0xfe,0xba,0xbe,0xfa,0xce,0xdb,0xad,0xde,0xca,0xf8,0x88};
  u8 expected_c9[]={0x39,0x80,0xca,0x0b,0x3c,0x00,0xe8,0x41,0xeb,0x06,0xfa,0xc4,0x87,0x2a,0x27,0x57,0x85,0x9e,0x1c,0xea,0xa6,0xef,0xd9,0x84,0x62,0x85,0x93,0xb4,0x0c,0xa1,0xe1,0x9c,0x7d,0x77,0x3d,0x00,0xc1,0x44,0xc5,0x25,0xac,0x61,0x9d,0x18,0xc8,0x4a,0x3f,0x47,0x18,0xe2,0x44,0x8b,0x2f,0xe3,0x24,0xd9,0xcc,0xda,0x27,0x10,0xac,0xad,0xe2,0x56};
  u8 expected_t9[UCL_AES_BLOCKSIZE]={0x99,0x24,0xa7,0xc8,0x58,0x73,0x36,0xbf,0xb1,0x18,0x02,0x4d,0xb8,0x67,0x4a,0x14};


  //key10 is key9
  //p10 is p6 (60 chars)
  //a10 is a6 (20 chars)
  //iv10 is iv9
  u8 expected_c10[60]={0x39,0x80,0xca,0x0b,0x3c,0x00,0xe8,0x41,0xeb,0x06,0xfa,0xc4,0x87,0x2a,0x27,0x57,0x85,0x9e,0x1c,0xea,0xa6,0xef,0xd9,0x84,0x62,0x85,0x93,0xb4,0x0c,0xa1,0xe1,0x9c,0x7d,0x77,0x3d,0x00,0xc1,0x44,0xc5,0x25,0xac,0x61,0x9d,0x18,0xc8,0x4a,0x3f,0x47,0x18,0xe2,0x44,0x8b,0x2f,0xe3,0x24,0xd9,0xcc,0xda,0x27,0x10};
  u8 expected_t10[16]={0x25,0x19,0x49,0x8e,0x80,0xf1,0x47,0x8f,0x37,0xba,0x55,0xbd,0x6d,0x27,0x61,0x8c};

  //AES 256
  u8 key13[UCL_AES_KEYLEN_256]={0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};
  //iv13 is iv
  u8 expected_t13[UCL_AES_BLOCKSIZE]={0x53,0x0f,0x8a,0xfb,0xc7,0x45,0x36,0xb9,0xa9,0x63,0xb4,0xf1,0xc4,0xcb,0x73,0x8b};

  //key14 is key13
  //p14 is pnull
  //iv14 is iv
  u8 expected_c14[]={0xce,0xa7,0x40,0x3d,0x4d,0x60,0x6b,0x6e,0x07,0x4e,0xc5,0xd3,0xba,0xf3,0x9d,0x18};
  u8 expected_t14[]={0xd0,0xd1,0xc8,0xa7,0x99,0x99,0x6b,0xf0,0x26,0x5b,0x98,0xb5,0xd4,0x8a,0xb9,0x19};

  u8 key15[UCL_AES_KEYLEN_256]={0xfe,0xff,0xe9,0x92,0x86,0x65,0x73,0x1c,0x6d,0x6a,0x8f,0x94,0x67,0x30,0x83,0x08,0xfe,0xff,0xe9,0x92,0x86,0x65,0x73,0x1c,0x6d,0x6a,0x8f,0x94,0x67,0x30,0x83,0x08};
  //p15 is p9 (64 chars)
  //iv15 is iv9
  u8 expected_c15[]={0x52,0x2d,0xc1,0xf0,0x99,0x56,0x7d,0x07,0xf4,0x7f,0x37,0xa3,0x2a,0x84,0x42,0x7d,0x64,0x3a,0x8c,0xdc,0xbf,0xe5,0xc0,0xc9,0x75,0x98,0xa2,0xbd,0x25,0x55,0xd1,0xaa,0x8c,0xb0,0x8e,0x48,0x59,0x0d,0xbb,0x3d,0xa7,0xb0,0x8b,0x10,0x56,0x82,0x88,0x38,0xc5,0xf6,0x1e,0x63,0x93,0xba,0x7a,0x0a,0xbc,0xc9,0xf6,0x62,0x89,0x80,0x15,0xad};
  u8 expected_t15[]={0xb0,0x94,0xda,0xc5,0xd9,0x34,0x71,0xbd,0xec,0x1a,0x50,0x22,0x70,0xe3,0xcc,0x6c};

  //key16 is key15
  //p16 is p6 (60 chars)
  //a16 is a6
  //iv16 is iv9
  u8 expected_c16[60]={0x52,0x2d,0xc1,0xf0,0x99,0x56,0x7d,0x07,0xf4,0x7f,0x37,0xa3,0x2a,0x84,0x42,0x7d,0x64,0x3a,0x8c,0xdc,0xbf,0xe5,0xc0,0xc9,0x75,0x98,0xa2,0xbd,0x25,0x55,0xd1,0xaa,0x8c,0xb0,0x8e,0x48,0x59,0x0d,0xbb,0x3d,0xa7,0xb0,0x8b,0x10,0x56,0x82,0x88,0x38,0xc5,0xf6,0x1e,0x63,0x93,0xba,0x7a,0x0a,0xbc,0xc9,0xf6,0x62};
  u8 expected_t16[]={0x76,0xfc,0x6e,0xce,0x0f,0x4e,0x17,0x68,0xcd,0xdf,0x88,0x53,0xbb,0x2d,0x55,0x1b};

  u8 res[UCL_AES_BLOCKSIZE];

  u8 h[UCL_AES_BLOCKSIZE];
  u8 eky0[UCL_AES_BLOCKSIZE];
  u8 y[UCL_AES_BLOCKSIZE];
  int i;
  int err,errc,errt;
  int resu;
  /* case 1: no plain, no aad, 96-bit iv, null key */
  //  ucl_gcm_init_r();now useless because the table is hardcoded

  ucl_gcm_init_m0(key,UCL_AES_KEYLEN_128,UCL_CIPHER_ENCRYPT);
  resu=ucl_aes_gcm_auth(t,128,c,p,0,0,a,0,0,key,ivnull,0,96,UCL_CIPHER_ENCRYPT);
  if(UCL_OK!=resu)
    {
      PRINTF("2.\n");
      return(UCL_ERROR);
    }
  resu=ucl_aes_gcm_auth(tprime,128,pprime,c,0,0,a,0,0,key,ivnull,0,96,UCL_CIPHER_DECRYPT);
  if(UCL_OK!=resu)
    {
      PRINTF("3.\n");
      return(UCL_ERROR);
    }
  err=0;
  if(memcmp(expected_t_case1,t,sizeof(expected_t_case1))!=0)
    {
      err=1;
      PRINTF("4.1\n");
    }
  if(err==0)
    if(memcmp(expected_t_case1,tprime,sizeof(expected_t_case1))!=0)
	err=1;
  if(1==err)
    {
      PRINTF("4.\n");
      return(UCL_ERROR);
    }

  ucl_gcm_init_m0(key,UCL_AES_KEYLEN_128,UCL_CIPHER_ENCRYPT);
  resu=ucl_aes_gcm(t,128,c,pnull,0,UCL_AES_BLOCKSIZE*8,a,0,0,key,16,ivnull,0,96,UCL_CIPHER_ENCRYPT);
  if(UCL_OK!=resu)
    {
      PRINTF("5.%d\n",resu);
      return(UCL_ERROR);
    }
  resu=ucl_aes_gcm_auth(tprime,128,pprime,c,0,UCL_AES_BLOCKSIZE*8,a,0,0,key,ivnull,0,96,UCL_CIPHER_DECRYPT);
  errt=errc=0;
  if(UCL_OK!=resu)
    {
      PRINTF("6.\n");
            return(UCL_ERROR);
    }
  if(memcmp(expected_t_case2,t,sizeof(expected_t_case2))!=0)
	errt=1;
  if(memcmp(expected_c_case2,c,sizeof(expected_c_case2))!=0)
	errc=1;
  if(memcmp(expected_t_case2,tprime,sizeof(expected_t_case2))!=0)
	errt=1;
  if(memcmp(pnull,pprime,sizeof(pnull))!=0)
	errc=1;
  if(1==errc || 1==errt)
    {
      PRINTF("7.\n");
          return(UCL_ERROR);
    }

  resu=ucl_aes_gcm(tprime,128,pprime,c,0,UCL_AES_BLOCKSIZE*8,a,0,0,key,16,ivnull,0,96,UCL_CIPHER_DECRYPT);
  errt=errc=0;
  if(UCL_OK!=resu)
    {
      PRINTF("6.\n");
            return(UCL_ERROR);
    }
  if(memcmp(expected_t_case2,tprime,sizeof(expected_t_case2))!=0)
	errt=1;
  if(memcmp(pnull,pprime,sizeof(pnull))!=0)
	errc=1;
  if(1==errc || 1==errt)
    {
      PRINTF("7b.\n");
          return(UCL_ERROR);
    }
  //  PRINTF("AES multi-part, 1 block\n");
  resu=ucl_aes_gcm_init(res,h,eky0,y,a,0,0,key,16,ivnull,0,96,UCL_CIPHER_DECRYPT);
  if(UCL_OK!=resu)
    PRINTF("gcm init error %d\n",resu);
  //core is used for processing all but the last block, so if we have 128 bits to process
  //we don't have to use core, but only finish
  //  resu=ucl_aes_gcm_core(res,128,pprime,c,0,0,0,0,h,y,key,16,UCL_CIPHER_DECRYPT);
  resu=ucl_aes_gcm_finish(tprime,128,res,pprime,c,0,128,0,128,0,0,h,eky0,y,key,16,UCL_CIPHER_DECRYPT);
  if(UCL_OK!=resu)
    PRINTF("gcm finish error %d\n",resu);

  ucl_gcm_init_m0(key3,UCL_AES_KEYLEN_128,UCL_CIPHER_ENCRYPT);
  resu=ucl_aes_gcm_auth(t,128,c3,p3,0,UCL_AES_BLOCKSIZE*4*8,a,0,0,key3,iv3,0,96,UCL_CIPHER_ENCRYPT);
  if(UCL_OK!=resu)
    {
      PRINTF("8.\n");
            return(UCL_ERROR);
    }
  //  PRINTF("******************************\n");
  //PRINTF("AES multi-part, 4 blocks in one core, one finish\n");
  resu=ucl_aes_gcm_init(res,h,eky0,y,a,0,0,key3,16,iv3,0,96,UCL_CIPHER_ENCRYPT);
  for(i=0;i<16*4;i++)
    pprime[i]=0;
  //we have 4 blocks to process
  //processing the 3 first blocks with _core
  resu=ucl_aes_gcm_core(res,128,c3,p3,0,128*3,0,0,h,y,key3,16,UCL_CIPHER_ENCRYPT);
  if(resu!=UCL_OK)
    PRINTF("error core %d\n",resu);
  //processing the last one with _finish
  resu=ucl_aes_gcm_finish(tprime,128,res,&(c3[3*16]),&(p3[3*16]),0,128,0,128*4,0,0,h,eky0,y,key3,16,UCL_CIPHER_ENCRYPT);
  if(resu!=UCL_OK)
    PRINTF("error gcm finish %d\n",resu);
  if(memcmp(expected_t_case3,tprime,16)==0)
    {
      //PRINTF("ENC tag OK\n");
    }
  else
    PRINTF("tag NOK\n");
  if(memcmp(c3,expected_c_case3,4*16)==0)
    {
      // PRINTF("encryption OK\n");
    }
  else
    PRINTF("encryption NOK\n");

  resu=ucl_aes_gcm_auth(tprime,128,pprime,c3,0,UCL_AES_BLOCKSIZE*4*8,a,0,0,key3,iv3,0,96,UCL_CIPHER_DECRYPT);
  if(UCL_OK!=resu)
    {
      PRINTF("9.\n");
      return(UCL_ERROR);
    }
  if(memcmp(expected_t_case3,t,sizeof(expected_t_case3))!=0)
	errt=1;
  if(memcmp(expected_c_case3,c3,sizeof(expected_c_case3))!=0)
	errc=1;
  if(memcmp(expected_t_case3,tprime,sizeof(expected_t_case3))!=0)
	errt=1;
  if(memcmp(p3,pprime,sizeof(p3))!=0)
	errc=1;
  if(1==errc || 1==errt)
    {
      PRINTF("10.\n");
          return(UCL_ERROR);
    }
  //  PRINTF("******************************\n");
  //PRINTF("AES multi-part, 4 blocks in one core, one finish\n");
  resu=ucl_aes_gcm_init(res,h,eky0,y,a,0,0,key3,16,iv3,0,96,UCL_CIPHER_DECRYPT);
  for(i=0;i<16*4;i++)
    pprime[i]=0;
  //we have 4 blocks to process
  //processing the 3 first blocks with _core
  resu=ucl_aes_gcm_core(res,128,pprime,c3,0,128*3,0,0,h,y,key3,16,UCL_CIPHER_DECRYPT);
  if(resu!=UCL_OK)
    PRINTF("error core %d\n",resu);
  //processing the last one with _finish
  resu=ucl_aes_gcm_finish(tprime,128,res,&(pprime[3*16]),&(c3[3*16]),0,128,0,128*4,0,0,h,eky0,y,key3,16,UCL_CIPHER_DECRYPT);
  if(resu!=UCL_OK)
    PRINTF("error gcm finish %d\n",resu);
  if(memcmp(expected_t_case3,tprime,16)==0)
    {
      //PRINTF("tag OK\n");
    }
  else
    PRINTF("tag NOK\n");
  if(memcmp(p3,pprime,4*16)==0)
    {
      //PRINTF("decryption OK\n");
    }
  else
    PRINTF("decryption NOK\n");

  //  PRINTF("******************************\n");
  //PRINTF("AES multi-part, 4 blocks in 2 cores, one finish\n");
  for(i=0;i<16*4;i++)
    pprime[i]=0;

  resu=ucl_aes_gcm_init(res,h,eky0,y,a,0,0,key3,16,iv3,0,96,UCL_CIPHER_DECRYPT);
  resu=ucl_aes_gcm_core(res,128,pprime,c3,0,128*2,0,0,h,y,key3,16,UCL_CIPHER_DECRYPT);
  resu=ucl_aes_gcm_core(res,128,&(pprime[16*2]),&(c3[16*2]),0,128,0,0,h,y,key3,16,UCL_CIPHER_DECRYPT);
  resu=ucl_aes_gcm_finish(tprime,128,res,&(pprime[3*16]),&(c3[3*16]),0,128,0,128*4,0,0,h,eky0,y,key3,16,UCL_CIPHER_DECRYPT);
  if(resu!=UCL_OK)
    PRINTF("error gcm finish %d\n",resu);
  if(memcmp(expected_t_case3,tprime,16)==0)
    {
      //PRINTF("tag OK\n");
    }
  else
    PRINTF("tag NOK\n");
  if(memcmp(p3,pprime,4*16)==0)
    {
      //PRINTF("decryption OK\n");
    }
  else
    PRINTF("decryption NOK\n");

  //PRINTF("******************************\n");
  //PRINTF("AES multi-part, 4 blocks in 3 cores, one finish\n");
  for(i=0;i<16*4;i++)
    pprime[i]=0;

  resu=ucl_aes_gcm_init(res,h,eky0,y,a,0,0,key3,16,iv3,0,96,UCL_CIPHER_DECRYPT);
  resu=ucl_aes_gcm_core(res,128,pprime,c3,0,128,0,0,h,y,key3,16,UCL_CIPHER_DECRYPT);
  resu=ucl_aes_gcm_core(res,128,&(pprime[16]),&(c3[16]),0,128,0,0,h,y,key3,16,UCL_CIPHER_DECRYPT);
  resu=ucl_aes_gcm_core(res,128,&(pprime[16*2]),&(c3[16*2]),0,128,0,0,h,y,key3,16,UCL_CIPHER_DECRYPT);
  resu=ucl_aes_gcm_finish(tprime,128,res,&(pprime[3*16]),&(c3[3*16]),0,128,0,128*4,0,0,h,eky0,y,key3,16,UCL_CIPHER_DECRYPT);
  if(resu!=UCL_OK)
    PRINTF("error gcm finish %d\n",resu);
  if(memcmp(expected_t_case3,tprime,16)==0)
    {
      //PRINTF("tag OK\n");
    }
  else
    PRINTF("tag NOK\n");
  if(memcmp(p3,pprime,4*16)==0)
    {
      //PRINTF("decryption OK\n");
    }
  else
    PRINTF("decryption NOK\n");

  resu=ucl_aes_gcm_auth(t,128,c4,p4,0,60*8,a4,0,20*8,key3,iv4,0,96,UCL_CIPHER_ENCRYPT);
  if(UCL_OK!=resu)
    {
      PRINTF("11.\n");
            return(UCL_ERROR);
    }
  resu=ucl_aes_gcm_init(res,h,eky0,y,a4,0,20*8,key3,16,iv4,0,96,UCL_CIPHER_ENCRYPT);
  /*  PRINTF("eky0\n");
  for(i=0;i<16;i++)
    PRINTF("%02x",eky0[i]);
    PRINTF("\n");*/
  //core processes 3 blocks (3*128 bits) and remaining bits (60*8=480-384=96 bits) are processed by the finish
  resu=ucl_aes_gcm_core(res,128,c4,p4,0,3*128,0,20*8,h,y,key3,16,UCL_CIPHER_ENCRYPT);
  resu=ucl_aes_gcm_finish(tprime,128,res,&(c4[3*16]),&(p4[3*16]),0,96,0,60*8,0,20*8,h,eky0,y,key3,16,UCL_CIPHER_ENCRYPT);
  if(memcmp(expected_t_case4,tprime,sizeof(expected_t_case4))!=0)
    {
      PRINTF("ENC tag is wrong\n");
      for(i=0;i<16;i++)
	PRINTF("%02x",tprime[i]);
      PRINTF("\n");
      for(i=0;i<16;i++)
	PRINTF("%02x",expected_t_case4[i]);
      PRINTF("\n");
    }
  else
    {
      //PRINTF("ENC tag is ok\n");
    }
  if(memcmp(expected_c_case4,c4,sizeof(expected_c_case4))!=0)
    {
      PRINTF("ENC crypto is wrong\n");
    }
  else
    {
      //    PRINTF("ENC crypto is ok\n");
    }
  resu=ucl_aes_gcm_auth(tprime,128,pprime,c4,0,60*8,a4,0,20*8,key3,iv4,0,96,UCL_CIPHER_DECRYPT);
  if(UCL_OK!=resu)
    {
      PRINTF("12.\n");
      return(UCL_ERROR);
    }
  if(memcmp(expected_t_case4,t,sizeof(expected_t_case4))!=0)
    errt=1;
  if(memcmp(expected_c_case4,c4,sizeof(expected_c_case4))!=0)
    errc=1;
  if(memcmp(expected_t_case4,tprime,sizeof(expected_t_case4))!=0)
    errt=1;
  if(memcmp(p4,pprime,sizeof(p4))!=0)
    errc=1;
  if(1==errc || 1==errt)
    {
      PRINTF("13.\n");
      return(UCL_ERROR);
    }
  resu=ucl_aes_gcm_init(res,h,eky0,y,a4,0,20*8,key3,16,iv4,0,96,UCL_CIPHER_DECRYPT);
  //int ucl_aes_gcm_core(u8 *res,int auth_tag_bit_len,u8 *c,u8 *p,int input_bit_len_high,int input_bit_len_low,int aad_bit_len_high,int aad_bit_len_low,u8 *h,u8 *y,u8 *key,u32 keylen,int mode)
  //core processes 3 blocks (3*128 bits) and remaining bits (60*8=480-384=96 bits) are processed by the finish
  resu=ucl_aes_gcm_core(res,128,pprime,c4,0,3*128,0,20*8,h,y,key3,16,UCL_CIPHER_DECRYPT);
  //int ucl_aes_gcm_finish(u8 *auth_tag,int auth_tag_bit_len,u8 *res,u8 *c,u8 *p,int input_bit_len_high,int input_bit_len_low,int inputtot_bit_len_high,int inputtot_bit_len_low,int aad_bit_len_high,int aad_bit_len_low,u8 *h,u8 *eky0,u8 *y,u8 *key,u32 keylen,int mode)
  resu=ucl_aes_gcm_finish(tprime,128,res,&(pprime[3*16]),&(c4[3*16]),0,96,0,60*8,0,20*8,h,eky0,y,key3,16,UCL_CIPHER_DECRYPT);
  if(memcmp(expected_t_case4,tprime,sizeof(expected_t_case4))!=0)
    {
      PRINTF("DEC tag is wrong\n");
      for(i=0;i<16;i++)
	PRINTF("%02x",tprime[i]);
      PRINTF("\n");
      for(i=0;i<16;i++)
	PRINTF("%02x",expected_t_case4[i]);
      PRINTF("\n");
    }
  /*  else
      PRINTF("DEC tag is ok\n");*/
  if(memcmp(p4,pprime,sizeof(expected_c_case4))!=0)
    {
      PRINTF("DEC plain is wrong\n");
    }
  /*  else
      PRINTF("DEC plain is ok\n");*/

  resu=ucl_aes_gcm_auth(t,128,c5,p5,0,60*8,a5,0,20*8,key3,iv5,0,8*8,UCL_CIPHER_ENCRYPT);
  if(UCL_OK!=resu)
    {
      PRINTF("14.\n");
      return(UCL_ERROR);
    }
  resu=ucl_aes_gcm_auth(tprime,128,pprime,c5,0,60*8,a5,0,20*8,key3,iv5,0,8*8,UCL_CIPHER_DECRYPT);
  if(UCL_OK!=resu)
    {
      PRINTF("15.\n");
      return(UCL_ERROR);
    }
  if(memcmp(expected_t_case5,t,sizeof(expected_t_case5))!=0)
    errt=1;
  if(memcmp(expected_c_case5,c5,sizeof(expected_c_case5))!=0)
    errc=1;
  if(memcmp(expected_t_case5,tprime,sizeof(expected_t_case5))!=0)
    errt=1;
  if(memcmp(p5,pprime,sizeof(p5))!=0)
    errc=1;

  if(1==errc || 1==errt)
    {
      PRINTF("16.\n");
      return(UCL_ERROR);
    }

  resu=ucl_aes_gcm_auth(t,128,c6,p6,0,60*8,a6,0,20*8,key3,iv6,0,60*8,UCL_CIPHER_ENCRYPT);
  if(UCL_OK!=resu)
    {
      PRINTF("17.\n");
      return(UCL_ERROR);
    }
  resu=ucl_aes_gcm_auth(tprime,128,pprime,c6,0,60*8,a6,0,20*8,key3,iv6,0,60*8,UCL_CIPHER_DECRYPT);
  if(UCL_OK!=resu)
    {
      PRINTF("18.\n");
      return(UCL_ERROR);
    }
  if(memcmp(expected_t_case6,t,sizeof(expected_t_case6))!=0)
    errt=1;
  if(memcmp(expected_c_case6,c6,sizeof(expected_c_case6))!=0)
    errc=1;
  if(memcmp(expected_t_case6,tprime,sizeof(expected_t_case6))!=0)
    errt=1;
  if(memcmp(p6,pprime,sizeof(p6))!=0)
    errc=1;
  if(1==errc || 1==errt)
    {
      PRINTF("19.\n");
      return(UCL_ERROR);
    }
  //AES 192
  //tc7

  resu=ucl_aes_gcm(t,128,c,pnull,0,0,a6,0,0,key7,UCL_AES_KEYLEN_192,ivnull,0,96,UCL_CIPHER_ENCRYPT);
  if(UCL_OK!=resu)
    {
      PRINTF("20.\n");
      //      return(UCL_ERROR);
    }
  if(memcmp(expected_t7,t,UCL_AES_BLOCKSIZE)!=0)
    {
      PRINTF("21.\n");
    }

  //tc8
  ucl_gcm_init_m0(key7,UCL_AES_KEYLEN_192,UCL_CIPHER_ENCRYPT);
  resu=ucl_aes_gcm(t,16*8,c,pnull,0,16*8,a6,0,0,key7,UCL_AES_KEYLEN_192,ivnull,0,96,UCL_CIPHER_ENCRYPT);
  if(UCL_OK!=resu)
    {
      PRINTF("22.\n");
      return(UCL_ERROR);
    }

  if(memcmp(expected_c8,c,UCL_AES_BLOCKSIZE)!=0)
     PRINTF("23.\n");
  if(memcmp(expected_t8,t,UCL_AES_BLOCKSIZE)!=0)
      PRINTF("24.\n");
  //tc9
  ucl_gcm_init_m0(key9,UCL_AES_KEYLEN_192,UCL_CIPHER_ENCRYPT);
  resu=ucl_aes_gcm(t,128,c,p9,0,64*8,a6,0,0,key9,UCL_AES_KEYLEN_192,iv9,0,12*8,UCL_CIPHER_ENCRYPT);
  if(UCL_OK!=resu)
    {
      PRINTF("25.\n");
      return(UCL_ERROR);
    }
  if(memcmp(expected_c9,c,64)!=0)
      PRINTF("26.\n");
  if(memcmp(expected_t9,t,16)!=0)
      PRINTF("27.\n");
  //tc10
  resu=ucl_aes_gcm(t,16*8,c,p6,0,60*8,a6,0,20*8,key9,UCL_AES_KEYLEN_192,iv9,0,12*8,UCL_CIPHER_ENCRYPT);
  if(UCL_OK!=resu)
    {
      PRINTF("28.\n");
      return(UCL_ERROR);
    }
  if(memcmp(expected_c10,c,60)!=0)
      PRINTF("29.\n");
  if(memcmp(expected_t10,t,UCL_AES_BLOCKSIZE)!=0)
      PRINTF("30.\n");

  //AES-256
  //tc13
  ucl_gcm_init_m0(key13,UCL_AES_KEYLEN_256,UCL_CIPHER_ENCRYPT);
  resu=ucl_aes_gcm(t,16*8,c,pnull,0,0,a6,0,0,key13,UCL_AES_KEYLEN_256,ivnull,0,12*8,UCL_CIPHER_ENCRYPT);
  if(UCL_OK!=resu)
    {
      PRINTF("31.\n");
      return(UCL_ERROR);
    }
  if(memcmp(expected_t13,t,UCL_AES_BLOCKSIZE)!=0)
      PRINTF("32.\n");

  //tc14
  resu=ucl_aes_gcm(t,16*8,c,pnull,0,16*8,a6,0,0,key13,UCL_AES_KEYLEN_256,ivnull,0,12*8,UCL_CIPHER_ENCRYPT);
  if(UCL_OK!=resu)
    {
      PRINTF("33.\n");
      return(UCL_ERROR);
    }

  if(memcmp(expected_c14,c,16)!=0)
      PRINTF("34.\n");
  if(memcmp(expected_t14,t,UCL_AES_BLOCKSIZE)!=0)
      PRINTF("35.\n");

  //tc15
  ucl_gcm_init_m0(key15,UCL_AES_KEYLEN_256,UCL_CIPHER_ENCRYPT);
  resu=ucl_aes_gcm(t,16*8,c,p9,0,64*8,a6,0,0,key15,UCL_AES_KEYLEN_256,iv9,0,12*8,UCL_CIPHER_ENCRYPT);
  if(UCL_OK!=resu)
    {
      PRINTF("36.\n");
      return(UCL_ERROR);
    }
  if(memcmp(expected_c15,c,64)!=0)
    {
      PRINTF("37.\n");
    }
  if(memcmp(expected_t15,t,UCL_AES_BLOCKSIZE)!=0)
      PRINTF("38.\n");
  
  //tc16
  resu=ucl_aes_gcm(t,16*8,c,p6,0,60*8,a6,0,20*8,key15,UCL_AES_KEYLEN_256,iv9,0,12*8,UCL_CIPHER_ENCRYPT);
  if(UCL_OK!=resu)
    {
      PRINTF("39.\n");
      return(UCL_ERROR);
    }
  if(memcmp(expected_c16,c,60)!=0)
      PRINTF("40.\n");
  if(memcmp(expected_t16,t,UCL_AES_BLOCKSIZE)!=0)
      PRINTF("41.\n");
  return(UCL_OK);
}


void ucl_stress_aes_gcm(int nb4096bytes)
{
  u8 zero[UCL_AES_BLOCKSIZE];
  u8 h[UCL_AES_BLOCKSIZE];
  u8 key4[UCL_AES_KEYLEN_128]= {0xfe,0xff,0xe9,0x92,0x86,0x65,0x73,0x1c,0x6d,0x6a,0x8f,0x94,0x67,0x30,0x83,0x08};
  u8 key5[UCL_AES_KEYLEN_256]= {0xfe,0xff,0xe9,0x92,0x86,0x65,0x73,0x1c,0x6d,0x6a,0x8f,0x94,0x67,0x30,0x83,0x08,0xfe,0xff,0xe9,0x92,0x86,0x65,0x73,0x1c,0x6d,0x6a,0x8f,0x94,0x67,0x30,0x83,0x08};
  u8 a4[20]={0xfe,0xed,0xfa,0xce,0xde,0xad,0xbe,0xef,0xfe,0xed,0xfa,0xce,0xde,0xad,0xbe,0xef,0xab,0xad,0xda,0xd2};
  u8 iv4[96/8]={0xca,0xfe,0xba,0xbe,0xfa,0xce,0xdb,0xad,0xde,0xca,0xf8,0x88};
  u8 p[4096];
  u8 t[UCL_AES_BLOCKSIZE];
  int i;
  int plain_size;
  int iloop;
  PRINTF("STRESS AES GCM %d\n",nb4096bytes);
  for(i=0;i<(int)sizeof(p);i++)
    p[i]=i;

  // stress with 96-bit IV, i.e. recommended length
  //  ucl_gcm_init_r();useless
  for(i=0;i<16;i++)
    zero[i]=0;
  PRINTF("AES-GCM 128\n");
  //  ucl_aes_ecb(h,zero,UCL_AES_BLOCKSIZE,key4,UCL_AES_KEYLEN_128,UCL_CIPHER_ENCRYPT);
  //ucl_gcm_init_prod(h);
  ucl_gcm_init_m0(key4,UCL_AES_KEYLEN_128,UCL_CIPHER_ENCRYPT);
  // 12 bytes is the recommended value by the RFC 5084
  //stress performed per "plain_size"-byte packet
  plain_size=1024;
  display_time();
  for(iloop=0;iloop<nb4096bytes;iloop++)
    {
      ucl_aes_gcm_auth(t,128,p,p,0,plain_size*8,a4,0,12*8,key4,iv4,0,96,UCL_CIPHER_ENCRYPT);
    }
  display_time();
  PRINTF("AES-GCM 256\n");
  ucl_aes_ecb(h,zero,UCL_AES_BLOCKSIZE,key5,UCL_AES_KEYLEN_256,UCL_CIPHER_ENCRYPT);
  ucl_gcm_init_prod(h);
  // 12 bytes is the recommended value by the RFC 5084
  //stress performed per "plain_size"-byte packet
  display_time();
  for(iloop=0;iloop<nb4096bytes;iloop++)
    {
      ucl_aes_gcm(t,128,p,p,0,plain_size*8,a4,0,12*8,key4,UCL_AES_KEYLEN_256,iv4,0,96,UCL_CIPHER_ENCRYPT);
    }
  display_time();
}

void ucl_stress_aes_gmac(int nb4096bytes)
{
  u8 zero[UCL_AES_BLOCKSIZE];
  u8 h[UCL_AES_BLOCKSIZE];
  u8 key4[UCL_AES_KEYLEN_128]= {0xfe,0xff,0xe9,0x92,0x86,0x65,0x73,0x1c,0x6d,0x6a,0x8f,0x94,0x67,0x30,0x83,0x08};
  u8 a4[20]={0xfe,0xed,0xfa,0xce,0xde,0xad,0xbe,0xef,0xfe,0xed,0xfa,0xce,0xde,0xad,0xbe,0xef,0xab,0xad,0xda,0xd2};
  u8 iv4[96/8]={0xca,0xfe,0xba,0xbe,0xfa,0xce,0xdb,0xad,0xde,0xca,0xf8,0x88};
  u8 p[4096];
  u8 t[UCL_AES_BLOCKSIZE];
  int i;
  int iloop;
  for(i=0;i<(int)sizeof(p);i++)
    p[i]=i;

  // stress with 96-bit IV, i.e. recommended length
  //  ucl_gcm_init_r();useless
  for(i=0;i<16;i++)
    zero[i]=0;
  ucl_aes_ecb(h,zero,UCL_AES_BLOCKSIZE,key4,UCL_AES_KEYLEN_128,UCL_CIPHER_ENCRYPT);
  ucl_gcm_init_prod(h);
  // 12 bytes is the recommended value by the RFC 5084
  //stress performed per 4096-byte packet
  for(iloop=0;iloop<nb4096bytes;iloop++)
    {
      ucl_aes_gcm_auth(t,128,p,p,0,0,a4,0,12*8,key4,iv4,0,96,UCL_CIPHER_ENCRYPT);
    }
}

int test_gcm(void)
{
  PRINTF("AES GCM ");
  if(UCL_OK==test_aes_gcm())
    PRINTF("OK\n");
  else
    {
      PRINTF("NOK\n");
      return(UCL_ERROR);
    }
  if(1!=test_mike())
    PRINTF("Mike test NOK\n");
  test_large_aes_gcm();
  ucl_stress_aes_gcm(1000);
  return(UCL_OK);
}
#endif//AES_GCM
